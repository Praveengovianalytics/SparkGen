version: v1
name: sparkgen-rag-agentic
description: Reference workflow for Spec-as-Code RAG + Agentic pipelines.
entry_agent: researcher
environment: dev

rag:
  enabled: true
  retriever: in_memory
  top_k: 5
  embedding_model: local-hash-128
  chunking:
    size: 800
    overlap: 100
    strategy: sliding_window
  reranker:
    enabled: true
    provider: local
    top_n: 2
  citations: true
  collection: product_docs
  knowledge_bases:
    - name: product_docs
      description: "Product documentation and orchestration patterns."
      collection: product_docs
      contexts:
        - contexts/product_context.md
    - name: responsible_ai
      description: "Guardrails, safety, and compliance notes."
      collection: rai_policies
      contexts:
        - contexts/responsible_ai.md
  default_knowledge_bases:
    - product_docs
    - responsible_ai

storage:
  vector_store:
    backend: azure_ai_search
    collection: product_vectors
    azure_ai_search:
      endpoint: ${AZURE_SEARCH_ENDPOINT}
      index_name: sparkgen-product-index
      api_version: 2024-07-01-preview
      auth:
        use_msi: true
        msi_client_id_env: ${AZURE_SEARCH_CLIENT_ID}
    faiss:
      index_path: data/faiss/index.faiss
      metadata_store_path: data/faiss/metadata.json
    credentials:
      auth_token: ${VECTOR_DB_TOKEN}
  document_store:
    backend: filesystem
    path: data/docs
    credentials: {}
  memory_store_path: .sparkgen_memory.json

memory:
  short_term:
    store: memory_store
    ttl_messages: 25
    summarization_policy: summarize
  long_term:
    store: vector_store
    ttl_messages: null
    summarization_policy: summarize

tools:
  builtin:
    - get_delivery_date
  mcp_connectors:
    - name: demo-gateway
      host: localhost
      port: 9999
      protocol: ws
      active: true
      credentials:
        token: ${MCP_DEMO_TOKEN}
      tools:
        - name: demo.calculator
          resource: demo.calculator
          description: Quick math helper for retrieval scoring.
    - name: docs-gateway
      host: localhost
      port: 7000
      protocol: ws
      active: false
      credentials:
        token: ${DOCS_GATEWAY_TOKEN}
      tools:
        - name: docs.search
          resource: docs.search
          description: Search structured documentation snippets.
  exposed_mcp_tools:
    - mcp__demo_gateway__demo_calculator

guardrails:
  defaults_path: guardrails/default_guardrails.yaml
  documentation: guardrails/README.md
  workflow_doc: guardrails/workflow.md
  apply_sets:
    - platform_defaults
    - workflow_rag
  sets:
    - name: workflow_rag
      description: "Workflow-specific rails for RAG + agentic orchestration."
      docs: guardrails/workflow.md
      rules:
        - name: citations_encouraged
          description: "Warn if research answers omit citations."
          categories: ["citations"]
          applies_to: ["output"]
          mode: warn
          severity: medium
          priority: 20
          patterns:
            - "(?i)(citation needed|no reference)"
          message_templates:
            escalation: "Add citations for each claim or refuse if sources are unavailable."
        - name: tooling_privacy_warn
          description: "Warn if tool calls could leak raw user inputs."
          categories: ["tool_use_constraints", "privacy"]
          applies_to: ["tool"]
          mode: warn
          severity: high
          priority: 25
          patterns:
            - "mcp__demo_gateway__demo_calculator"
          tags: ["tooling"]

agents:
  - name: researcher
    role: "Research analyst focused on evidence-gathering."
    prompt_file: prompts/researcher.md
    context_file: contexts/product_context.md
    tools:
      - mcp__demo_gateway__demo_calculator
    memory:
      short_term: true
      long_term: true
    guardrails:
      use_sets:
        - workflow_rag
      overrides:
        - name: researcher_no_secrets
          description: "Block sharing secrets or passwords."
          categories: ["policy", "privacy"]
          applies_to: ["output"]
          mode: block
          severity: high
          priority: 8
          patterns:
            - "(secret|password)"
          message_templates:
            refusal: "I cannot disclose secrets or passwords."
      doc: guardrails/agents/researcher.md
    handoff_notes: "Summarize findings and cite sources before handing off."
  - name: coder
    role: "Engineer turning research into actions and patches."
    prompt_file: prompts/coder.md
    context_file: contexts/product_context.md
    tools:
      - get_delivery_date
    memory:
      short_term: true
      long_term: false
    guardrails:
      use_sets:
        - platform_defaults
      overrides:
        - name: coder_patch_concise
          description: "Keep patch suggestions concise."
          categories: ["constraints", "safety"]
          applies_to: ["output"]
          mode: warn
          severity: low
          priority: 40
          patterns: []
          message_templates:
            escalation: "Keep responses concise (<1400 chars) and actionable."
      doc: guardrails/agents/coder.md

handoffs:
  - source: researcher
    target: coder
    trigger: always
    message_contract: "Summaries with citations and TODO list."

observability:
  logging: verbose
  tracing: true
  metrics: true
  run_id_env: RUN_ID
  telemetry_endpoint: https://telemetry.example.com/events
  mlflow_tracking_uri: http://localhost:5000
  langfuse_host: https://cloud.langfuse.com
  langfuse_public_key_env: LANGFUSE_PUBLIC_KEY
  langfuse_secret_key_env: LANGFUSE_SECRET_KEY

llm:
  provider: openai
  model: gpt-4o-mini
  api_key_env: LLM_API_KEY
  use_agents_sdk: false
  agent_id_env: OPENAI_AGENT_ID

environments:
  staging:
    rag:
      top_k: 3
    observability:
      telemetry_endpoint: https://telemetry.staging.example.com/events
  prod:
    llm:
      model: gpt-4o
    rag:
      top_k: 8
